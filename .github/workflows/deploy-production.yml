name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true

env:
  AZURE_RESOURCE_GROUP: stitches-prod
  AZURE_WEBAPP_NAME: app-stitches-prod
  DOTNET_VERSION: '10.0.x'
  NODE_VERSION: '20'

jobs:
  validate-input:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        if: github.event.inputs.confirm != 'deploy'
        run: |
          echo "âŒ Deployment not confirmed. Type 'deploy' to confirm."
          exit 1

  test-frontend:
    needs: validate-input
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
        working-directory: frontend
      
      - name: Run tests
        run: npm test -- --run
        working-directory: frontend

  test-backend:
    needs: validate-input
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies
        run: dotnet restore
        working-directory: backend
      
      - name: Run tests
        run: dotnet test --no-restore --verbosity normal
        working-directory: backend

  build-frontend:
    needs: test-frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
        working-directory: frontend
      
      - name: Build
        run: npm run build
        working-directory: frontend
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

  build-backend:
    needs: test-backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies
        run: dotnet restore
        working-directory: backend
      
      - name: Publish
        run: dotnet publish src/Api -c Release -o ./publish
        working-directory: backend
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-publish
          path: backend/publish

  provision-infrastructure:
    needs: [build-frontend, build-backend]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy Bicep
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: infrastructure/bicep/main.bicep
          parameters: infrastructure/bicep/parameters/prod.parameters.json sqlAdministratorPassword=${{ secrets.SQL_ADMIN_PASSWORD }}
          failOnStdErr: false

  migrate-database:
    needs: provision-infrastructure
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Get connection string
        id: get-secret
        run: |
          CONNECTION_STRING=$(az keyvault secret show --vault-name kv-stitches-prod --name DatabaseConnectionString --query value -o tsv)
          echo "::add-mask::$CONNECTION_STRING"
          echo "connection_string=$CONNECTION_STRING" >> $GITHUB_OUTPUT
      
      - name: Run migrations
        run: |
          dotnet ef database update --project src/Infrastructure --startup-project src/Api
        working-directory: backend
        env:
          ConnectionStrings__DefaultConnection: ${{ steps.get-secret.outputs.connection_string }}

  deploy-app:
    needs: migrate-database
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend-dist
      
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-publish
          path: backend-publish
      
      - name: Copy frontend to backend wwwroot
        run: |
          mkdir -p backend-publish/wwwroot
          cp -r frontend-dist/* backend-publish/wwwroot/
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          package: backend-publish

  smoke-test:
    needs: deploy-app
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run smoke tests
        run: |
          chmod +x infrastructure/scripts/smoke-test.sh
          ./infrastructure/scripts/smoke-test.sh prod
